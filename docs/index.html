<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flashcards: Einb√ºrgerungstest</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap');

        :root {
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --primary-text: #333;
            --secondary-text: #555;
            --accent-color: #007bff;
            --hover-color: #0056b3;
            --correct-color: #28a745;
            --incorrect-color: #dc3545;
            --skip-color: #ffc107;
            --border-color: #ddd;
        }

        body {
            font-family: 'Roboto', sans-serif;
            background-color: var(--background-color);
            color: var(--primary-text);
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
            box-sizing: border-box;
        }

        .container {
            width: 100%;
            max-width: 500px;
            background-color: var(--card-background);
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            overflow: hidden;
        }

        .screen {
            padding: 20px 30px 30px 30px;
        }

        .hidden {
            display: none;
        }

        h1, h2 {
            text-align: center;
            color: var(--secondary-text);
            margin-top: 0;
        }

        /* --- Menu Screen --- */
        #menu-screen {
            text-align: center;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 700;
        }

        .form-group select {
            width: 100%;
            padding: 10px;
            font-size: 1em;
            border: 2px solid var(--border-color);
            border-radius: 8px;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
            text-align: left;
        }
        .checkbox-group label {
            margin-bottom: 0;
            font-weight: normal;
        }
        .checkbox-group input {
            transform: scale(1.2);
        }

        .btn {
            display: block;
            width: 100%;
            padding: 15px;
            font-size: 1.1em;
            font-weight: 700;
            cursor: pointer;
            border: none;
            border-radius: 8px;
            color: #fff;
            background-color: var(--accent-color);
            transition: background-color 0.2s ease;
            margin-top: 10px;
            box-sizing: border-box;
        }

        .btn:not(:disabled):hover {
            background-color: var(--hover-color);
        }
        
        .btn:disabled {
            background-color: #aaa;
            cursor: not-allowed;
        }

        .btn-secondary {
            background-color: #6c757d;
        }
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .btn-danger {
            background-color: var(--incorrect-color);
            margin-top: 20px;
        }
        .btn-danger:hover {
            background-color: #c82333;
        }

        /* --- Game Screen --- */
        .scoreboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px 15px;
            padding: 15px;
            background-color: #fafafa;
            border-radius: 8px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            font-size: 0.95em;
        }

        .stat {
            text-align: center;
        }
        .stat-title {
            font-size: 0.8em;
            color: var(--secondary-text);
            font-weight: 700;
            text-transform: uppercase;
        }
        .stat-value {
            font-size: 1.2em;
            font-weight: 700;
        }
        #correct-count { color: var(--correct-color); }
        #incorrect-count { color: var(--incorrect-color); }
        #skip-count { color: var(--skip-color); }
        #total-time { color: var(--primary-text); }
        #avg-time { color: var(--primary-text); }

        .flashcard {
            text-align: center;
            padding: 20px 0;
        }

        #question-text {
            font-size: 2.2em;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 20px;
            min-height: 50px;
        }

        #options-container {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 20px;
        }

        .option-btn {
            display: block;
            width: 100%;
            background-color: #f9f9f9;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            font-size: 1em;
            text-align: left;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .option-btn:not(:disabled):hover {
            border-color: var(--accent-color);
            background-color: #e6f2ff;
        }
        .option-btn:disabled {
            cursor: not-allowed;
            opacity: 0.9;
        }
        .option-btn.correct {
            background-color: #eaf7ec;
            border-color: var(--correct-color);
            font-weight: 700;
            color: var(--correct-color);
        }
        .option-btn.incorrect {
            background-color: #fdeeee;
            border-color: var(--incorrect-color);
            font-weight: 700;
            color: var(--incorrect-color);
        }

        .game-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        #skip-btn {
            background-color: var(--skip-color);
        }
        #skip-btn:hover {
            background-color: #e0a800;
        }

        /* --- History Screen --- */
        #history-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-bottom: 20px;
        }
        
        .history-entry {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        .history-entry:last-child {
            border-bottom: none;
        }
        .history-entry-date {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .history-entry-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 5px;
            font-size: 0.9em;
        }
        .history-entry-stats span {
            display: block;
        }

        /* --- Footer --- */
        .footer-credits {
            margin-top: 30px;
            text-align: center;
            font-size: 0.9em;
            color: var(--secondary-text);
        }
        .footer-credits p {
            margin: 0;
        }
        .footer-credits a {
            color: var(--accent-color);
            text-decoration: none;
            font-weight: 700;
        }
        .footer-credits a:hover {
            text-decoration: underline;
        }

    </style>
</head>
<body>

    <div class="container">

        <div id="menu-screen" class="screen">
            <h1>Flashcards: Einb√ºrgerungstest</h1>

            <div class="form-group">
                <label for="lang-select" data-translate-key="answerLang">Answer Language:</label>
                <select id="lang-select">
                    <option value="pt">Portugu√™s (pt-br)</option>
                    <option value="en">English (en-us)</option>
                </select>
            </div>

            <button id="new-game-btn" class="btn" data-translate-key="newGame">New Game</button>
            <button id="history-btn" class="btn btn-secondary" data-translate-key="history">History</button>
            
            <div class="footer-credits">
                <p>
                    <span data-translate-key="credits">Created by</span>: <a href="https://github.com/alexandre-leites/einburgerungstest-flashcards" target="_blank">alexslx<a/> | 
                    <a href="https://github.com/alexandre-leites/einburgerungstest-flashcards" target="_blank">GitHub</a> | 
                    <a href="https://buymeacoffee.com/alexandreleites" target="_blank" data-translate-key="donateBuyMeACoffee">Buy Me A Coffee</a> |
                    <a href="https://buymeacoffee.com/alexandreleites" target="_blank" data-translate-key="donatePayPal">PayPal</a>
                </p>
            </div>
        </div>

        <div id="game-screen" class="screen hidden">
            <h2 data-translate-key="gameTitle">Einb√ºrgerungstest</h2>
            
            <div class="scoreboard">
                <div class="stat"><span id="correct-count" class="stat-value">0</span> <span class="stat-title" data-translate-key="statCorrect">Correct</span></div>
                <div class="stat"><span id="incorrect-count" class="stat-value">0</span> <span class="stat-title" data-translate-key="statIncorrect">Incorrect</span></div>
                <div class="stat"><span id="skip-count" class="stat-value">0</span> <span class="stat-title" data-translate-key="statSkipped">Skipped</span></div>
                <div class="stat"><span id="total-time" class="stat-value">00:00</span> <span class="stat-title" data-translate-key="statTotalTime">Total Time</span></div>
                <div class="stat" style="grid-column: 1 / -1;"><span id="avg-time" class="stat-value">0.0s</span> <span class="stat-title" data-translate-key="statAvgTime">Avg. Time / Q</span></div>
            </div>

            <div class="flashcard">
                <div id="question-text">Loading...</div>
            </div>

            <div id="options-container"></div>

            <div class="game-controls">
                <button id="skip-btn" class="btn" data-translate-key="skipBtn">Skip</button>
                <button id="end-game-btn" class="btn btn-secondary" data-translate-key="endGameBtn">End Game</button>
            </div>
        </div>

        <div id="history-screen" class="screen hidden">
            <h2 data-translate-key="historyTitle">Game History</h2>
            
            <div id="history-list">
                <p data-translate-key="noHistory">No games in history.</p>
            </div>

            <button id="clear-history-btn" class="btn btn-danger" data-translate-key="clearHistoryBtn">Clear History</button>
            <button id="back-to-menu-btn" class="btn btn-secondary" data-translate-key="backToMenuBtn">Back to Menu</button>
        </div>

    </div>

    <script>
        // --- 1. Internacionaliza√ß√£o (i18n) ---
        const translations = {
            en: {
                answerLang: "Answer Language:",
                invertOrder: "Invert (Answer -> German)",
                newGame: "New Game",
                history: "History",
                loading: "Loading...",
                gameTitle: "Einb√ºrgerungstest",
                statCorrect: "Correct",
                statIncorrect: "Incorrect",
                statSkipped: "Skipped",
                statTotalTime: "Total Time",
                statAvgTime: "Avg. Time / Q",
                skipBtn: "Skip",
                endGameBtn: "End Game",
                historyTitle: "Game History",
                noHistory: "No games in history.",
                clearHistoryBtn: "Clear History",
                backToMenuBtn: "Back to Menu",
                confirmClear: "Are you sure you want to clear all history?",
                historyEntryDate: "Date",
                historyEntryLang: "Language",
                historyEntryLangPt: "Portuguese",
                historyEntryLangEn: "English",
                historyEntryCorrect: "Correct",
                historyEntryIncorrect: "Incorrect",
                historyEntrySkipped: "Skipped",
                historyEntryTotalTime: "Total Time",
                historyEntryAvgTime: "Avg. Time",
                historyEntryAvgTimeSuffix: "/ question",
                credits: "Created by",
                donateBuyMeACoffee: "Buy Me A Coffee",
                donatePaypal: "PayPal",
                loadError: "Error: Could not load word list. Check file path or network.",
            },
            pt: {
                answerLang: "Idioma da Resposta:",
                invertOrder: "Inverter (Resposta -> Alem√£o)",
                newGame: "Novo Jogo",
                history: "Hist√≥rico",
                loading: "Carregando...",
                gameTitle: "Einb√ºrgerungstest",
                statCorrect: "Corretas",
                statIncorrect: "Incorretas",
                statSkipped: "Puladas",
                statTotalTime: "Tempo Total",
                statAvgTime: "Tempo M√©dio / Q",
                skipBtn: "Pular",
                endGameBtn: "Terminar Jogo",
                historyTitle: "Hist√≥rico de Jogos",
                noHistory: "Nenhum jogo no hist√≥rico.",
                clearHistoryBtn: "Limpar Hist√≥rico",
                backToMenuBtn: "Voltar ao Menu",
                confirmClear: "Tem certeza que deseja limpar todo o hist√≥rico?",
                historyEntryDate: "Data",
                historyEntryLang: "Idioma",
                historyEntryLangPt: "Portugu√™s",
                historyEntryLangEn: "Ingl√™s",
                historyEntryCorrect: "Corretas",
                historyEntryIncorrect: "Incorretas",
                historyEntrySkipped: "Puladas",
                historyEntryTotalTime: "Tempo Total",
                historyEntryAvgTime: "Tempo M√©dio",
                historyEntryAvgTimeSuffix: "/ quest√£o",
                credits: "Criado por",
                donateBuyMeACoffee: "Buy Me A Coffee",
                donatePaypal: "PayPal",
                loadError: "Erro: N√£o foi poss√≠vel carregar a lista. Verifique o caminho do arquivo ou a rede.",
            }
        };

        function applyTranslations(lang) {
            const strings = translations[lang] || translations.en;
            document.querySelectorAll('[data-translate-key]').forEach(el => {
                const key = el.dataset.translateKey;
                if (strings[key]) {
                    el.textContent = strings[key];
                }
            });
            // Atualiza elementos que n√£o s√£o est√°ticos
            const historyListP = ui.historyList.querySelector('p[data-translate-key="noHistory"]');
            if (historyListP) {
                historyListP.textContent = strings.noHistory;
            }
        }
        
        // --- 2. Vari√°veis Globais ---
        let wordList = []; // Ser√° preenchida por fetch
        let gameHistory = [];
        let currentGame = {};
        let currentCorrectAnswer = null;
        let totalTimeInterval = null;
        let questionStartTime = null;

        const HISTORY_KEY = "flashcardHistory";
        const SETTINGS_KEY = "flashcardSettings";
        const TOTAL_OPTIONS = 5;
        const SIMILAR_OPTIONS_COUNT = 2;

        // --- 3. Elementos do DOM ---
        const screens = {
            menu: document.getElementById('menu-screen'),
            game: document.getElementById('game-screen'),
            history: document.getElementById('history-screen')
        };
        const buttons = {
            newGame: document.getElementById('new-game-btn'),
            history: document.getElementById('history-btn'),
            backToMenu: document.getElementById('back-to-menu-btn'),
            clearHistory: document.getElementById('clear-history-btn'),
            skip: document.getElementById('skip-btn'),
            endGame: document.getElementById('end-game-btn')
        };
        const ui = {
            langSelect: document.getElementById('lang-select'),
            questionText: document.getElementById('question-text'),
            optionsContainer: document.getElementById('options-container'),
            historyList: document.getElementById('history-list'),
            // Placar
            correctCount: document.getElementById('correct-count'),
            incorrectCount: document.getElementById('incorrect-count'),
            skipCount: document.getElementById('skip-count'),
            totalTime: document.getElementById('total-time'),
            avgTime: document.getElementById('avg-time')
        };

        // --- 4. Navega√ß√£o entre Telas ---
        function showScreen(screenId) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenId].classList.remove('hidden');
        }

        // --- 5. Fun√ß√µes de Formata√ß√£o e Utilit√°rios ---
        function formatTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const min = String(Math.floor(seconds / 60)).padStart(2, '0');
            const sec = String(seconds % 60).padStart(2, '0');
            return `${min}:${sec}`;
        }
        
        function formatAvgTime(ms) {
            if (ms === 0) return '0.0s';
            return (ms / 1000).toFixed(1) + 's';
        }
        
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // --- 6. L√≥gica de Configura√ß√µes e Hist√≥rico (LocalStorage) ---
        function loadSettings() {
            const settings = JSON.parse(localStorage.getItem(SETTINGS_KEY)) || {};
            const lang = settings.uiLang || 'en'; // Default 'en'

            ui.langSelect.value = lang;
            
            return lang;
        }

        function saveSettings() {
            const settings = {
                uiLang: ui.langSelect.value
            };
            localStorage.setItem(SETTINGS_KEY, JSON.stringify(settings));
        }

        function handleSettingsChange() {
            saveSettings();
            applyTranslations(ui.langSelect.value);
            // Re-renderiza o hist√≥rico se estiver vis√≠vel, para traduzir as datas/legendas
            if (!screens.history.classList.contains('hidden')) {
                renderHistory();
            }
        }

        function loadHistory() {
            gameHistory = JSON.parse(localStorage.getItem(HISTORY_KEY)) || [];
        }

        function saveHistory() {
            localStorage.setItem(HISTORY_KEY, JSON.stringify(gameHistory));
        }
        
        function renderHistory() {
            ui.historyList.innerHTML = '';
            const uiLang = ui.langSelect.value || 'en';
            const strings = translations[uiLang] || translations.en;
            
            if (gameHistory.length === 0) {
                ui.historyList.innerHTML = `<p style="text-align: center;" data-translate-key="noHistory">${strings.noHistory}</p>`;
                return;
            }
            
            gameHistory.slice().reverse().forEach(game => {
                const date = new Date(game.date).toLocaleString(uiLang.startsWith('pt') ? 'pt-BR' : 'en-US');
                const lang = game.lang === 'pt' ? strings.historyEntryLangPt : strings.historyEntryLangEn;
                const totalTime = formatTime(game.totalTime);
                const avgTime = formatAvgTime(game.avgTime);
                
                const entry = document.createElement('div');
                entry.className = 'history-entry';
                entry.innerHTML = `
                    <div class="history-entry-date">${date} (${strings.historyEntryLang}: ${lang})</div>
                    <div class="history-entry-stats">
                        <span>‚úÖ ${strings.historyEntryCorrect}: ${game.correct}</span>
                        <span>‚ùå ${strings.historyEntryIncorrect}: ${game.incorrect}</span>
                        <span>‚Ü∑ ${strings.historyEntrySkipped}: ${game.skipped}</span>
                        <span>‚è±Ô∏è ${strings.historyEntryTotalTime}: ${totalTime}</span>
                        <span style="grid-column: 1 / -1;">üìä ${strings.historyEntryAvgTime}: ${avgTime} ${strings.historyEntryAvgTimeSuffix}</span>
                    </div>
                `;
                ui.historyList.appendChild(entry);
            });
        }
        
        function showHistoryScreen() {
            renderHistory();
            showScreen('history');
        }
        
        function clearHistory() {
            const uiLang = ui.langSelect.value || 'en';
            const strings = translations[uiLang] || translations.en;
            if (confirm(strings.confirmClear)) {
                gameHistory = [];
                saveHistory();
                renderHistory();
            }
        }

        // --- 7. L√≥gica do Jogo ---
        
        async function startLoadingGame() {
            const lang = ui.langSelect.value;
            const strings = translations[lang] || translations.en;
            
            buttons.newGame.disabled = true;
            buttons.newGame.textContent = strings.loading;

            try {
                const response = await fetch(`data/words_${lang}.json`);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                wordList = await response.json();
                
                if (wordList.length === 0) {
                     throw new Error("Word list loaded but is empty.");
                }

                startGame(lang);

            } catch (error) {
                console.error('Failed to load word list:', error);
                alert(strings.loadError);
            } finally {
                buttons.newGame.disabled = false;
                applyTranslations(lang); // Restaura o texto original do bot√£o
            }
        }
        
        function updateTimers() {
            const elapsedMs = Date.now() - currentGame.startTime;
            ui.totalTime.textContent = formatTime(elapsedMs);
        }
        
        function updateAverageTime() {
            if (currentGame.questionTimes.length === 0) {
                ui.avgTime.textContent = '0.0s';
                return;
            }
            const total = currentGame.questionTimes.reduce((a, b) => a + b, 0);
            const avg = total / currentGame.questionTimes.length;
            ui.avgTime.textContent = formatAvgTime(avg);
        }

        function startGame(lang) {
            currentGame = {
                lang: lang,
                correct: 0,
                incorrect: 0,
                skipped: 0,
                startTime: Date.now(),
                questionTimes: [],
                date: new Date().toISOString()
            };
            
            ui.correctCount.textContent = '0';
            ui.incorrectCount.textContent = '0';
            ui.skipCount.textContent = '0';
            
            totalTimeInterval = setInterval(updateTimers, 1000);
            updateTimers();
            updateAverageTime();
            
            loadNewQuestion();
            showScreen('game');
        }
        
        function endGame() {
            clearInterval(totalTimeInterval);
            
            currentGame.totalTime = Date.now() - currentGame.startTime;
            const totalQuestionTime = currentGame.questionTimes.reduce((a, b) => a + b, 0);
            currentGame.avgTime = (currentGame.questionTimes.length > 0) 
                                ? totalQuestionTime / currentGame.questionTimes.length 
                                : 0;
            
            gameHistory.push(currentGame);
            saveHistory();
            
            currentGame = {};
            wordList = []; // Limpa a wordlist da mem√≥ria
            showScreen('menu');
        }

        function loadNewQuestion() {
            ui.optionsContainer.innerHTML = '';
            
            const lang = currentGame.lang;
            const invert = Math.random() < 0.15; // 15% chance to invert this card
            
            // Define qual chave √© a pergunta e qual √© a resposta
            const questionKey = invert ? lang : 'de';
            const answerKey = invert ? 'de' : lang;

            // 1. Escolhe a palavra correta
            const correctEntry = wordList[Math.floor(Math.random() * wordList.length)];
            currentCorrectAnswer = correctEntry[answerKey];
            
            let optionsSet = new Set();
            optionsSet.add(currentCorrectAnswer);

            // 2. Encontra op√ß√µes "similares" (mesma categoria)
            let similarCandidates = wordList.filter(entry => 
                entry.category === correctEntry.category && entry[answerKey] !== currentCorrectAnswer
            );
            shuffle(similarCandidates);
            
            for (let i = 0; i < SIMILAR_OPTIONS_COUNT && i < similarCandidates.length; i++) {
                optionsSet.add(similarCandidates[i][answerKey]);
            }
            
            // 3. Encontra op√ß√µes "aleat√≥rias" (para completar 5)
            let randomCandidates = wordList.filter(entry => entry[answerKey] !== currentCorrectAnswer);
            shuffle(randomCandidates);

            let candidateIndex = 0;
            while (optionsSet.size < TOTAL_OPTIONS && candidateIndex < randomCandidates.length) {
                optionsSet.add(randomCandidates[candidateIndex][answerKey]);
                candidateIndex++;
            }
            
            // 4. Renderiza
            ui.questionText.textContent = correctEntry[questionKey];
            
            let finalOptions = shuffle(Array.from(optionsSet));
            finalOptions.forEach(optionText => {
                const button = document.createElement('button');
                button.className = 'option-btn';
                button.textContent = optionText;
                button.onclick = () => checkAnswer(optionText, button);
                ui.optionsContainer.appendChild(button);
            });
            
            questionStartTime = Date.now();
        }

        function recordQuestionTime() {
            const duration = Date.now() - questionStartTime;
            currentGame.questionTimes.push(duration);
            updateAverageTime();
        }

        function checkAnswer(selectedText, buttonEl) {
            recordQuestionTime();
            
            document.querySelectorAll('.option-btn').forEach(btn => btn.disabled = true);
            let delayTime = 350;
            
            if (selectedText === currentCorrectAnswer) {
                currentGame.correct++;
                ui.correctCount.textContent = currentGame.correct;
                buttonEl.classList.add('correct');
            } else {
                currentGame.incorrect++;
                ui.incorrectCount.textContent = currentGame.incorrect;
                buttonEl.classList.add('incorrect');
                delayTime = 1500;
                
                document.querySelectorAll('.option-btn').forEach(btn => {
                    if (btn.textContent === currentCorrectAnswer) {
                        btn.classList.add('correct');
                    }
                });
            }
            
            setTimeout(loadNewQuestion, delayTime);
        }

        function skipQuestion() {
            recordQuestionTime();
            
            currentGame.skipped++;
            ui.skipCount.textContent = currentGame.skipped;
            
            loadNewQuestion();
        }

        // --- 8. Inicializa√ß√£o ---
        document.addEventListener('DOMContentLoaded', () => {
            buttons.newGame.onclick = startLoadingGame;
            buttons.history.onclick = showHistoryScreen;
            buttons.backToMenu.onclick = () => showScreen('menu');
            buttons.clearHistory.onclick = clearHistory;
            buttons.skip.onclick = skipQuestion;
            buttons.endGame.onclick = endGame;
            
            ui.langSelect.onchange = handleSettingsChange;
            
            loadHistory();
            const initialLang = loadSettings(); // Carrega e aplica settings salvos
            applyTranslations(initialLang); // Aplica tradu√ß√µes na carga inicial
            
            showScreen('menu');
        });

    </script>
</body>
</html>